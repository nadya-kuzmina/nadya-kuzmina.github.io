<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>The HTML5 Herald</title>
    <meta name="description" content="The HTML5 Herald">
    <meta name="author" content="SitePoint">
    <link rel="stylesheet" href="css/styles.css?v=1.0">
    <!-- <script src="{{ url_for('static', filename='js/web.js') }}"></script> -->
</head>

<body onload="init();">
    <h1>Take a snapshot of the current video stream</h1>
    Click on the Start WebCam button.
    <p>
        <button onclick="startWebcam();">Start WebCam</button>
        <button onclick="stopWebcam();">Stop WebCam</button>
        <button onclick="snapshot();">Take Snapshot</button>
    </p>
    <video onclick="snapshot(this);" width=400 height=400 id="video" autoplay playsinline></video>
    <p>
        Screenshots :
    <p>
        <canvas id="myCanvas" width="400" height="350"></canvas>
    <p>
    <div id="message-output"></div>
</body>
<script>
    //--------------------
    // GET USER MEDIA CODE
    //--------------------
    MediaDevices.getUserMedia = (MediaDevices.getUserMedia ||
        MediaDevices.webkitGetUserMedia ||
        MediaDevices.mozGetUserMedia ||
        MediaDevices.msGetUserMedia);

    var video;
    var webcamStream;
    var imageBase64;

    function startWebcam() {
        if (navigator.getUserMedia) {
            navigator.getUserMedia(

                // constraints
                {
                    video: { facingMode: { exact: "environment" } },
                    audio: false
                },

                // successCallback
                function (localMediaStream) {
                    video = document.querySelector('video');
                    video.srcObject = localMediaStream;
                    webcamStream = localMediaStream;
                },

                // errorCallback
                function (err) {
                    console.log("The following error occured: " + err);
                }
            );
        } else {
            console.log("getUserMedia not supported");
        }
    }

    function stopWebcam() {
        webcamStream.stop();
    }
    //---------------------
    // TAKE A SNAPSHOT CODE
    //---------------------
    var canvas, ctx;

    function init() {
        // Get the canvas and obtain a context for
        // drawing in it
        canvas = document.getElementById("myCanvas");
        ctx = canvas.getContext('2d');
    }

    function snapshot() {
        // Draws current image from the video element into the canvas
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Кодирование в Base64
        imageBase64 = canvas.toDataURL('image/jpeg');

        var messageOutputTest = document.getElementById("message-output");
        messageOutputTest.innerHTML = "imageBase64: " + imageBase64;

        // Создание объекта с данными для отправки
        var requestData = {
            data: imageBase64
        };

        // Создание HTTP-запроса
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/detect", true);
        xhr.setRequestHeader("Content-type", "application/json");

        // Отправка данных на серверный API
        xhr.send(JSON.stringify(requestData));

        // Обработчик события изменения состояния запроса
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var responseJson = JSON.parse(xhr.responseText);
                var message = responseJson.message;
                var messageOutput = document.getElementById("message-output");
                messageOutput.innerHTML = "Server message: " + message;
            }
        };
    }

</script>

</html>
